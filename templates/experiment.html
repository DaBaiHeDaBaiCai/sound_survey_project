<!DOCTYPE html>
<html lang="{{ 'zh' if version == 'cn' else 'ja' }}">
<head>
  <meta charset="UTF-8">
  <title>{{ '声音认可度调查问卷（中文版）' if version == 'cn' else '声に対する印象調査アンケート（日本語版）' }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <style>
    .container { max-width: 820px; margin: 40px auto; }
    h1 { text-align:center; margin-bottom: 8px; }
    .legend { text-align:center; color:#667085; margin: 0 0 18px; font-size: 14px; }
    audio { width:100%; margin: 18px 0 10px; border-radius: 12px; }

    .question-block { margin: 26px 0; }
    .question-title { font-weight: 700; margin-bottom: 10px; color:#1f2937; }

    .likert {
      display: grid;
      grid-template-columns: 88px repeat(5, 1fr) 88px;
      align-items: center;
      column-gap: 10px;
      row-gap: 6px;
    }
    .end { color:#8a8f98; font-size: 13px; white-space: nowrap; }
    .end.left { justify-self: start; }
    .end.right { justify-self: end; }

    .opt { justify-self: center; font-weight: 500; color:#374151; }
    .opt input[type="radio"] { transform: scale(1.25); margin-right: 6px; accent-color: #2d89ef; }
    .opt input[disabled] { filter: grayscale(100%); opacity: .6; cursor: not-allowed; }

    .actions { text-align:center; margin-top: 28px; }
    .btn-primary {
      background:#2d89ef; color:#fff; border:none; padding:10px 22px;
      border-radius:10px; font-weight:600; box-shadow: 0 6px 14px rgba(45,137,239,.18);
    }
    .btn-primary:disabled { opacity:.45; box-shadow:none; cursor:not-allowed; }
  </style>

  <script>
    let audioPlayed = false;

    function allAnswered() {
      for (let i = 1; i <= 5; i++) {
        if (!document.querySelector('input[name="q' + i + '"]:checked')) return false;
      }
      return true;
    }

    function onAudioEnded() {
      audioPlayed = true;
      document.querySelectorAll('input[type="radio"]').forEach(r => r.disabled = false);
      updateNextButton();
    }

    function updateNextButton() {
      const btn = document.getElementById('nextBtn');
      btn.disabled = !(audioPlayed && allAnswered());
    }

    function confirmSubmit() {
      if (!audioPlayed) {
        alert("请先完整播放音频 / 音声を最後まで再生してください。");
        return false;
      }
      if (!allAnswered()) {
        alert("请先完成所有题目 / すべての質問に回答してください。");
        return false;
      }
      return true;
    }
  </script>
</head>
<body>
  <div class="container">
    <h1>{{ '声音认可度调查问卷（中文版）' if version == 'cn' else '声に対する印象調査アンケート（日本語版）' }}</h1>
    <p class="legend">{{ '第' if version == 'cn' else '第' }} {{ index }} / {{ total }}</p>

    <audio controls onended="onAudioEnded()">
      <source src="{{ stim['url'] }}" type="audio/wav">
      您的浏览器不支持音频播放 / お使いのブラウザは音声再生に対応していません。
    </audio>

    <p class="legend">
      {{ '请完整播放音频后作答。评分：1 = 非常低，5 = 非常高。' if version == 'cn'
         else '音声を最後まで再生してから回答してください。評価：1＝非常に低い，5＝非常に高い。' }}
    </p>

    <form method="post" onsubmit="return confirmSubmit()">
      <input type="hidden" name="stimulus_label" value="{{ stim['stimulus_label'] }}">
      <input type="hidden" name="person" value="{{ stim['person'] }}">
      <input type="hidden" name="trial_index" value="{{ stim['index'] }}">
      <input type="hidden" name="start_time" value="{{ start_time }}">

      {% if version == 'cn' %}
        {% set questions = [
          '1. 这段话容易听清（不费力）',
          '2. 喜欢这个声音',
          '3. 觉得亲切',
          '4. 这个声音有些违和感',
          '5. 感到疏远、冷淡、不亲切'
        ] %}
        {% set left_label = '非常低' %}
        {% set right_label = '非常高' %}
      {% else %}
        {% set questions = [
          '1. この音声は聞き取りやすい',
          '2. この音声に好感を持った',
          '3. この音声に親近感を持った',
          '4. この音声に違和感を持った',
          '5. この音声によそよそしさを感じた'
        ] %}
        {% set left_label = '非常に低い' %}
        {% set right_label = '非常に高い' %}
      {% endif %}

      {% for q in questions %}
        {% set qi = loop.index %}  {# 记录外层题号，供内层循环使用 #}
        <div class="question-block">
          <div class="question-title">{{ q }}</div>
          <div class="likert" onchange="updateNextButton()">
            <div class="end left">{{ left_label }}</div>

            {% for s in range(1,6) %}
              <label class="opt">
                <input type="radio" name="q{{ qi }}" value="{{ s }}" required disabled> {{ s }}
              </label>
            {% endfor %}

            <div class="end right">{{ right_label }}</div>
          </div>
        </div>
      {% endfor %}

      <div class="actions">
        <button id="nextBtn" type="submit" class="btn-primary" disabled>
          {{ '下一题' if index < total else '提交' if version == 'cn' else ('次へ' if index < total else '送信') }}
        </button>
      </div>
    </form>
  </div>
</body>
</html>